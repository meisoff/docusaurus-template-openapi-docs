---
id: external-signing-kep
title: "Подписание КЭП во внешней системе"
description: "Подписание КЭП во внешней системе"
---

## Коллекция

[POSTMAN КОЛЛЕКЦИЯ](https://drive.google.com/file/d/17eG39lXfeazygDGncsUjMGXmhqi9MqGr/view?usp=sharing)

## Диаграмма последовательности вызова методов

![Подписание КЭП во внешней системе](https://svgshare.com/i/16Lj.svg")

## 1. Первоначальные проверки

Перед созданием пакета документов можно провести первоначальные проверки, чтобы убедится в правильности составленного маршрута.

1. **Проверьте, что пользователь зарегистрирован в nopaper**

Для этого используйте метод [Проверить наличие пользователя](http://web.ru). В запросе укажите номер телефона пользователя `phone`, которого хотите проверить. Если пользователь зарегистрирован - сервис вернёт идентификатор пользователя `userGuid`.

:::note Примечание

- Если пользователь должен подписать документ с помощью КЭП от лица компании, то его регистрация в сервисе необязательна.
- Минимальная длина номера телефона - 8 цифр (сервис поддерживает регистрацию с ин. номерами)

:::

2. **Проверьте наличие компании в nopaper**

Для этого используйте метод [Проверить наличие компании](http://web.ru). В запросе укажите ИНН организации `inn`. Сервис вернёт список подходящих компаний с краткой информацией (идентификатор компании, КПП, короткое название).

:::note Примечание

- Реквизиты для юридического лица — ИНН и КПП; для ИП — только ИНН.

:::

3. **Получить список компаний, где пользователь является сотрудником**

Для этого используйте метод [Получить список компаний, где пользователь является сотрудником](http://web.ru). В запросе укажите номер телефона `phone` или `email` пользователя. Сервис вернёт список подходящих компаний с краткой информацией (идентификатор компании, КПП, короткое название).


## 2. Создание пакета документов

Чтобы создать пакет документов в сервисе, нужно выполнить 3 шага:
1. Создать черновик пакета документов
2. Прикрепить файлы к пакету документов
3. Отправить пакет документов в работу

### 2.1. Создать черновик пакета документов


Партнёр может создать черновик пакета документов с заданным маршрутом  с помощью метода [«Создать черновик пакета документов с заданным маршрутом»](http://web.ru). В запросе укажите название пакета документов, настройки пакета документов (1), реквизиты участников пакета документов (2) и настройки участников маршрута пакета документа (3).

<details><summary>Настройки пакета документов (1)</summary>
<p style={{overflowX: "hidden"}}>
    (1) В настройках пакета документа документа необходимо передать тип маршрута документа – documentRouteType. Он может быть последовательный или параллельный: если выбрать параллельный – документ отправляется на подписание сразу всем участникам маршрута, если выбрать последовательный – документ отправляется на подписание первому участнику маршрута, переданному в запросе, когда первый участник маршрута подпишет документ отправится второму участнику и т.д. Подробное описание каждого типа маршрута см в п.2.1.1. и п.2.1.2.
</p>
<p style={{overflowX: "hidden"}}>
    Также в настройках необходимо указать возможность редактирования маршрута участниками документа – isDisableChange. Когда настройка выключена (False), каждый участник документа может редактировать маршрут. Когда настройка включена (True), возможность редактирования маршрута зависит от владельца документа:
</p>
<p style={{overflowX: "hidden"}}>
    —   Если владелец документа является физическим лицом, то только он может редактировать маршрут;
</p>
<p style={{overflowX: "hidden"}}>
    —   Если владелец документа является юридическим лицом, то как владелец документа, так и сотрудники с правом просмотра всех документов компании могут редактировать маршрут.
</p>
</details>

<details><summary>Реквизиты участников пакета документов (2)</summary>
    <p style={{overflowX: "hidden"}}>
        (2) В реквизитах участников маршрута необходимо указать параметры которые соответствуют типу получателя:
    </p>
    <p style={{overflowX: "hidden"}}>
        —   Для отправления документа физ.лицу необходимо передать номер телефона. Отправить документ можно как зарегистрированному физ.лицу, так и незарегистрированному физ.лицу.
    </p>
    <p style={{overflowX: "hidden"}}>
        —   Для отправления документа юридическому лицу или ИП необходимо передать: ИНН организации, КПП организации (при наличии). Если компания зарегистрирована, документ будет отправлен контактному лицу компании. Если компания не зарегистрирована, документ будет отправлен на имя компании.
    </p>
    <p style={{overflowX: "hidden"}}>
        —   Для отправления документа определённому сотруднику юридического лица или ИП требуется передать: ИНН организации, КПП организации (при наличии) + номер телефона сотрудника. Отправить документ можно как зарегистрированному сотруднику, так и незарегистрированному сотруднику
    </p>
</details>

(3) В настройках участников маршрута необходимо передать требуемый тип действия от участника маршрута – `actionType` и тип подписания – `SignType`.

::::::info Варианты

:::info `actionType`
- подписание от имени физ. лица = 1
- подписание от имени юр. лица = 9
- согласование = 4
:::

:::info `SignType`
- НЭП = 1
- КЭП = 2
:::

::::::



В ответе nopaper вернёт идентификатор созданного пакета документов `documentId`, который требуется сохранить в системе партнёра, чтобы получать подробную информацию о пакете документов и информацию о подписи.

:::note Примечания
-   Для пакета документов есть возможность указать отправителя пакета документа – `userGuid`. Данный `userGuid` должен являться сотрудником Партнёра. Если отправитель не указан, документ будет отправлен от имени Компании.
-   После создания черновика, документ будет отображаться у отправителя черновика, если он был указан.
-   Прикрепить файлы и отправить черновик в работу можно как отправителю через мобильное приложение, так и через API запрос.
-   Изменить настройку редактирования маршрута для документа в работе можно методом [«Изменить разрешение редактирования маршрута»](http://web.ru)
:::

#### 2.1.1. Создать документ с последовательным маршрутом

Система партнёра может передавать документы в работу по последовательному маршруту, если требуется чтобы участники маршрута выполняли подписание/согласование в соответствии с очередью, один за другим. Очередь каждого участника задаётся в соответствии с порядком участников маршрута, переданных в запросе.

-   После выполнения активного действия предыдущего участника маршрута наступает очередь выполнения действия следующим участником маршрута. При наступлении очереди статус участника маршрута меняется с ***не активен*** на ***активен***. При изменении статуса участника с не активен на активен система Nopaper отправляет call-back в систему о наступлении очереди последующим участником маршрута.

#### 2.1.2. Создать документ с параллельным маршрутом

Система партнёра может передавать документы на подпись по параллельным маршруту, если требуется чтобы участники маршрута могли выполнить подписание/согласование в хаотичном порядке сразу после выполнения запроса.

-   При создании документа все Участники маршрута создаются со статусом ***активен***.

:::note Примечания
-   Для отправки пакета документов от имени сотрудника партнёра, в запросе необходимо передать идентификатор отправителя, который выполняет запрос создание документа. Отправителем может быть только физ. лицо, которое является сотрудником партнёра.
:::

### 2.2. Прикрепить файлы к пакету документов


Чтобы прикрепить файлы к пакету документов выполните метод [«Прикрепить файл к пакету документов»](http://web.ru). В запросе укажите идентификатор документа `documentId` и файл в формате base64.
В ответе сервис вернёт идентификатор загруженного файла `fileId`.

:::note Примечание

Если необходимо прикрепить несколько файлов к документу, то запрос необходимо вызвать столько раз – сколько файлов необходимо добавить.

:::

### 2.3. Отправить пакет документов в работу
Чтобы отправить пакет документов в работу выполните метод [«Отправить документ в работу»](http://web.ru). В запросе укажите идентификатор документа `documentId`, который нужно отправить в работу.

:::note Примечание

Отправить в работу можно только пакет документов со статусом = `New`

:::



## 3. Получение информации о пакете документов

По сценарию партнёру могут потребоваться следующие методы получения информации о пакетах документов:

### 3.1. Список исходящих и входящих документов

Партнёр может получить список доступных пакетов документов с помощью метода [«Получить список исходящих и входящих документов с использованием фильтров»](http://web.ru).

В ответе сервис вернёт список документов. Документы можно фильтровать. Полный список фильтров смотрите в описании метода.

:::note Примечания

- Если фильтры не переданы – nopaper вернёт информацию по 100 последним документам Партнёра.

:::

### 3.2. Получить детальную информацию о документе

Партнёр может получить подробную информацию о любом доступном документе с помощью метода [«Получить детальную информацию о пакете документов»](http://web.ru). В запросе укажите идентификатор документа `documentId`, по которому нужно получить информацию.

В ответе сервис вернет детальную информацию о документе.

:::info Call-back от Nopaper

- Потребность в получении информации о изменении статуса документа и статуса участника маршрута закрывает система уведомлений Nopaper.  Лучше использовать этот метод для получения детальной информации при получении входящего пакета документов или для синхронизации данных между системами в исключительных ситуациях.
- При изменении статуса пакета документов Партнёру отправляется `CallbackInfo(type(5))` (подробнее в документации [«Работа с уведомлениями call-back API Nopaper»](https://docs.google.com/document/d/1SlVeQU1px1EneqNoDn0pTgW0S0Ic6V_-g3PuT1b33g8/edit#heading=h.gjdgxs))

:::

### 3.3. Получить идентификаторы файлов

Партнёр может получить идентификаторы файлов, которые находятся в пакете документов с помощью метода [«Получить идентификаторы файлов»](http://web.ru). В запросе укажите идентификатор документа, по которому необходимо получить информацию.

В ответе сервис вернёт список идентификаторов файлов пакета документов.

:::note Примечание

По идентификатору можно
- загрузить файл
- получить подписи файла

:::

### 3.4. Получить файлы по идентификаторам
Партнёр может получить подписанные документы и печатные формы документов со штампом о подписи в Nopaper, когда документ перейдет в статус **завершен**. Чтобы получить подписанные документы нужно использовать последовательно два метода:

- сначала [«Получить идентификаторы файлов»](http://web.ru) — запрос вернёт массив идентификаторов файлов; в запросе требуется передать `documentId`.
- затем [«Получить файлы по идентификаторам»](http://web.ru) — запрос вернёт массив файлов, закодированных в формат base64.

:::info Call-back Nopaper
- При изменении статуса пакета документов Партнёру отправляется `CallbackInfo(type(5))` (подробнее в документации [«Работа с уведомлениями call-back API Nopaper»](https://docs.google.com/document/d/1SlVeQU1px1EneqNoDn0pTgW0S0Ic6V_-g3PuT1b33g8/edit#heading=h.gjdgxs))
:::

### 3.5. Получить подписи файла
После получения уведомления о переходе документа в статус завершён. Система партнёра может получить информацию о подписи документов, которые были подписаны в nopaper. Для этого нужно использовать последовательно два запроса:

- сначала [«Получить идентификаторы файлов»](http://web.ru) — запрос вернёт массив идентификаторов файлов; в запросе требуется передать `documentId`.
- затем [«Получить подписи к файлам»](http://web.ru) — запрос вернёт объект с информацией о подписи; в запросе требуется передать идентификатор файла.

:::info Call-back Nopaper
- При изменении статуса пакета документов Партнёру отправляется `CallbackInfo(type(5))` (подробнее в документации [«Работа с уведомлениями call-back API Nopaper»](https://docs.google.com/document/d/1SlVeQU1px1EneqNoDn0pTgW0S0Ic6V_-g3PuT1b33g8/edit#heading=h.gjdgxs))
:::

## 4. Подписание пакета документов

Партнёр может произвести подписание пакета документов КЭПом с помощью собственных средств. Данные средства должны формировать открепленные подписи формата CAdES для каждого файла в пакете документов.

:::note Примечание

- Для каждого файла в пакете документов должна быть своя открепленная подпись. Пакет документов с одной подписью не пройдет проверку сервиса.
- Подписать можно только документ с активным участником маршрута от вашей компании (документ в работе = `In progress`, участник маршрута = `Active`).

:::

### 4.1. Создание контейнера на подписание

Партнёр может отправить открепленные подписи на проверку в nopaper. Для начала проверки используйте метод [«Создать контейнер на подписание»](http://web.ru). В запросе передайте идентификатор документа `documentId`, который желаете подписать.

В ответе сервис вернет идентификатор контейнера `containerId` и идентификаторы файлов `fileId`, которые необходимо подписать.

### 4.2. Отправка подписей на проверку

Партнёр может отправить сформированные подписи на проверку в nopaper. Для этого используйте метод [«Отправить подписи на проверку»](http://web.ru). В запросе передайте идентификатор контейнера `containerId`, идентификаторы файлов `fileId` и открепленные подписи к ним в формате base64.

В ответе сервис вернет статус выполнения запроса.

:::note Примечание

- Для каждого файла в пакете документов должна быть своя открепленная подпись. Пакет документов с одной подписью не пройдет проверку сервиса.
- После успешного формирования подписи nopaper изменит статус участника маршрута – `signingPartyStatus` с `active` на `complete`.
- Если все участники маршрута выполнили своё активное действие, то документ переходит в статус `complete`. При переходе документа в статус `complete`, nopaper отправляет в систему Партнёра call-back.

:::

